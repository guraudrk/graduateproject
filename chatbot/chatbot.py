#flask로 챗봇을 보낼 때 쓰는 코드. 잡다한 것은 집어치우고 챗봇관련 코드만 적는다.
#이 코드를 vscode에서 실행할 때는 가상 환경 설정을 한다.


#chatbot.py는 챗봇 로직만 처리하고, server.py는 서버 통신을 처리하는 역활을 담당한다.
#이렇게, 코드를 분리하면 한번만 lstm을 훈련시키면 훈련된 모델을 사용해서 다양한 배포 환경에 적용 가능하다.

#가상환경을 만들어서 딥러닝을 처리하는 것이 더 나아서, 가상 환경을 만들어서 딥러닝을 처리했다.
"""
# 프로젝트 디렉토리로 이동
cd C:/Users/User/project2024/kingsejong

# 가상 환경 생성
C:/Users/User/AppData/Local/Programs/Python/Python311/python.exe -m venv venv

# 가상 환경 활성화
.\venv\Scripts\activate

# 패키지 설치
pip install numpy konlpy nltk scikit-learn tensorflow

# 스크립트 실행
python c:/Users/User/project2024/kingsejong/chatbot/chatbot.py
"""

import re

import numpy as np
from konlpy.tag import Okt
from nltk.tokenize import word_tokenize
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
from tensorflow.keras.layers import LSTM, Dense
from tensorflow.keras.models import Sequential
from tensorflow.keras.preprocessing.sequence import pad_sequences
from tensorflow.keras.preprocessing.text import Tokenizer

#정리된 데이터 배열을 정의한다.
#이 배열은 위 코드를 qa 형식으로 다시 정리한 것이다.
organized_data=[
    {"Q": "세종은 어떻게 왕위에 올랐나요?", "A": "세종은 원래 태종의 뒤를 이을 왕세자가 아니었으나, 양녕대군(讓寧大君)의 행동과 사건들로 인해 태종은 충녕대군(세종)을 왕세자로 책봉하고 왕위에 오르게 하였습니다."},
    {"Q": "세종 시대의 유교정치는 어떠했나요?", "A": "세종대는 정치적 안정 속에서 유교정치가 찬란히 꽃핀 시기로, 집현전을 통해 많은 인재를 양성하고 다양한 편찬 사업을 이루었으며, 농업과 과학기술, 의약기술, 음악, 법제의 발전을 이끌고, 기틀을 확고히 하였습니다."},
    {"Q": "세종대의 권력구조는 어떻게 변화했나요?", "A": "세종 18년을 전후로 육조직계제가 의정부서사제로 바뀌며 정치체제에 변혁이 있었고, 세종은 정치적 분위기를 안정되고 유연하게 만들었습니다.이와 같이 정치적 분위기가 변한 원인은 유교정치의 진전에서 찾을 수 있습니다. 세종 전반기에 집현전을 통해 많은 학자가 양성이 되었고, 그 학자들이 주축이 되어서 제도의 정리와 수많은 편찬사업을 펼쳐 유교정치의 기반이 마련되었습니다.세종 후반기에는 왕의 건강이 극히 악화되었으나, 의정부서사제 아래에서 군권과 신권이 조화를 이룬 가운데 성세를 구가한 시대였습니다. 황희(黃喜)를 비롯한 최윤덕(崔潤德) · 신개(申槪) · 하연(河演) 등 의정부 대신들은 중후하고 온건한 자세로 왕을 보좌하였습니다. 그리고 관료들의 정치 기강도 그 전후에 비해 건전했으며, 언관의 언론도 이상적인 유교정치를 구현하는 데 목표를 두었습니다. 이러한 정치체제와 정치적 분위기도 세종시대를 이룩하는 데 작용한 요소였습니다."},
    {"Q": "집현전의 역할과 목적은 무엇이었나요?", "A": "집현전은 유교정치와 대명 사대관계에 필요한 인재를 양성하고 학문을 진흥하기 위해 설치되었으며, 학자들은 학술 연구와 서적 편찬 등의 업무를 담당했습니다.집현전에 채용된 학자들은 여러가지 특혜가 있었습니다. 특히, 사가독서를 내려 학문에 전념할 수 있도록 하였습니다. 왕은 집현전의 학자들에게 학문에 전념할 것을 요구했습니다. 그 결과 수많은 인재를 배출했는데, 이러한 인적 자원이 바로 세종대의 찬란한 문화와 유교정치의 발전을 이루게 한 원동력이 되었습니다."},
    {"Q": "세종대의 주요 편찬 사업에는 어떤 것들이 있나요?", "A": "세종대에 전개된 다양하고 방대한 편찬사업은 이 시대의 문화수준을 높이는 데 기본이 되었다. 이 사업을 통해 문화적으로나 사상적으로 정리가 이루어졌고, 정치 · 제도의 기틀이 잡혀갔다. 이 사업의 주도자는 물론 세종이었고, 이 일을 담당한 것은 집현전과 여기에 소속된 학자들이었다. 또, 이 사업은 집현전 학자들의 학문이 향상되고 일할 수 있는 준비가 이루어진 세종 10년대부터 본격적으로 행해지고 있었습니다. 편찬물의 내용은 역사서, 유교경서, 유교윤리와 의례, 중국의 법률 및 문학서, 정치귀감서, 훈민정음 · 음운 · 언역(諺譯) 관계서, 지리서, 천문 · 역수서, 농서 등으로 다양하고 방대하였습니다. 즉, 정치 · 법률 · 역사 · 유교 · 문학 · 어학 · 천문 · 지리 · 의약 · 농업기술 등 각 분야에 걸쳐 종합 정리하는 사업으로, 이 작업을 통해 이 시대의 문화 수준을 한 단계 높은 수준으로 끌어올렸습니다. 또한, 특기할 일은 이러한 많은 편찬사업이 왕의 의도에 따른 것이었고, 왕 자신도 직접 참여하기도 했다는 사실입니다. 그 예로서 『자치통감훈의(資治通鑑訓義)』의 편찬은 집현전의 학자뿐 아니라, 53인이나 되는 거의 모든 학자들이 총동원되어 3년에 걸쳐 이룩한 큰 사업이었다. 그런데 이 사업을 위해 왕은 계속했던 경연까지 중지하고 밤늦게까지 친히 교정을 보았습니다. "},
    {"Q": "훈민정음의 창제 이유와 과정은 무엇인가요?", "A": "훈민정음은  1446년 9월에 발간된 책입니다. 훈민정음은 백성들이 자신의 뜻을 표현하는 데 어려움을 겪는 것을 해결하기 위해 창제되었습니다. 세종은 학자들과 함께 새로운 문자를 만들었고, 이를 통해 백성들이 쉽게 글을 배울 수 있도록 하였습니다. 훈민정음의 창제는 세종이 남긴 문화유산 가운데 가장 빛나는 업적입니다. 그리고 우리 민족의 문화유산 중에서도 가장 훌륭한 유산임에 분명합니다. 세종은 집현전을 통해 길러 낸 최항(崔恒) · 박팽년(朴彭年) · 신숙주(申叔舟) · 성삼문(成三問) · 이선로(李善老) · 이개(李塏) 등 소장 학자들의 협력을 받아 우리 민족의 문자를 창제하였습니다. 이것으로 보아 이 시대의 문화 의식과 수준이 어떠했는가를 가히 짐작할 수 있습니다."},
    {"Q": "세종대의 주요 과학기술 발명에는 어떤 것들이 있나요?", "A": "세종대에는 혼천의, 자격루, 측우기 등의 발명이 있었으며, 이 중 장영실이 중요한 역할을 했습니다. 천문대와 천문관측기계 방면에서의 발전이 이러한 측면의 하나로 꼽힙니다. 조선 초기 서운관에는 천문을 관측하기 위해 두 곳에 간의대(簡儀臺)주4를 설치한 바 있으나, 이것은 아주 미흡한 것이었습니다. 세종 14년부터 시작된 대규모의 천문의상(天文儀象)의 제작사업과 함께 경복궁의 경회루 북쪽에 높이 약 6.3m, 세로 약 9.1m, 가로 약 6.6m의 석축간의대가 세종 16년에 준공되었습니다. 그리고 이 간의대에는 혼천의(渾天儀) · 혼상(渾象) · 규표(圭表)와 방위(方位) 지정표(指定表)인 정방안(正方案) 등이 설치되었습니다. 세종 20년 3월부터 이 간의대에서 서운관의 관원들이 매일 밤 천문을 관측하였습니다. 이러한 간의대와 그 중요한 시설물들은 중국과 이슬람의 영향과 전통적인 요소들이 함께 들어 있었습니다."},
    {"Q": "혼천의는 무엇인가요?", "A": "혼천의는 세종 15년 6월에 제작된 천문 관측 기구로, 천체의 움직임을 측정하는 데 사용되었습니다. 이 혼천의는 천구의(天球儀)주5와 함께 물레바퀴를 동력으로 해 움직이는 시계장치와 연결되어 천체의 운행과 맞게 돌아가도록 되어서 일종의 천문시계의 성격도 가졌습니다."},
    {"Q": "세종대의 시계 발명은 무엇이 있나요?", "A": "세종대에는 다양한 시계들이 발명이 되었는데, 해시계로는 앙부일구(仰釜日晷) · 현주일구(懸珠日晷) · 천평일구(天平日晷) · 정남일구(定南日晷) 등이 있습니다. 그리고 물시계로는 자격루(自擊漏)와 옥루(玉漏)가 있습니다. 앙부일구는 우매한 백성들을 위해 혜정교(惠政橋)와 종묘 남쪽의 거리에 설치한 우리 나라 최초의 공중시계(公衆時計)였습니다. 또한, 현주일구와 천평일구는 휴대용 시계였으며, 정남일구는 매우 정밀한 해시계로 이것으로 관측하면 자연히 남쪽이 정해지면서 시각을 알 수 있도록 되어 있었습니다. "},
    {"Q": "자격루는 어떤 역할을 했나요?", "A": "자격루는 물의 흐름을 이용해 시간을 자동으로 알려주는 시계로, 주로 궁궐에서 사용되었습니다.자동시보장치가 붙은 물시계인 자격루는 세종이 크게 관심을 가졌던 것으로, 장영실을 특별히 등용해 이의 제작에 전념하게 해 세종 16년에 완성하였습니다. 그것은 경복궁 남쪽의 보루각(報漏閣)에 설치되어 조선시대의 표준시계로 이용하였습니다. 세종 20년에는 장영실에 의해 또 다른 자동물시계이며 천상시계인 옥루가 완성되었습니다."},
    {"Q": "장영실은 누구인가요?", "A": "장영실은 세종대의 대표적인 과학자로, 혼천의, 자격루, 측우기 등의 발명을 통해 과학기술 발전에 크게 기여했습니다. 수많은 발명의 공로로 장영실은 대호군에까지 승진했고, 그 은총에 보답하기 위해 천상시계,옥루(玉漏)등을 만들었습니다. 특히 장영실은 미천한 신불으로 테어나 대호군까지 승진한 입지전직인 인물로, 그 삶의 과정은 오늘날 우리에게 많은 영향을 주고 있습니다."},
    {"Q": "측우기는 무엇인가요?", "A": "측우기는 강수량을 측정하는 기구로, 세종대에 장영실이 발명하여 농업과 기상 관측에 중요한 역할을 했습니다.농업국가인 조선시대에서 강우량의 과학적 측정은 매우 큰 뜻을 가진다고 하겠습니다. 측우기는 세종 23년 8월에 발명되어 새로운 강우량의 측정제도가 마련되었고, 그 미흡한 점은 이듬해 5월에 개량 · 완성되었습니다. 이 측우기를 발명해 강우량을 측정함으로써 농업기상학의 괄목할 만한 진전을 이룩한 것입니다. 또, 조선시대의 도량형 제도도 세종대에 확정되었습니다. 즉, 세종 13년과 28년에 확정된 도량형제도가 그 뒤 『경국대전(經國大典)』에 그대로 법제화되었습니다. 이 제도는 12율(律)주6의 기본음인 황종률(黃鐘律)을 낼 수 있는 황종관(黃鐘管)주7을 표준기(標準器)로 삼은 것으로서, 황종관의 길이는 자[尺]로 길이의 단위를 삼았고, 그 속에 담기는 물은 무게의 단위로 삼은 것이었습니다."},
    {"Q": "세종대의 군사 기술 발전에는 어떤 것들이 있나요?", "A": "세종대에는 화약과 화포의 기술이 발전하였으며, 군사력 강화에 큰 기여를 했습니다."},
    {"Q": "화약과 화포 기술은 어떻게 발전했나요?", "A": "세종대에는 화약과 화포의 제조 기술이 발전하여 군사적 방어와 공격 능력이 크게 향상되었습니다. 완구(碗口)가 개량되고, 소화포(小火砲) · 철제탄환 · 화포전(火砲箭)주8 · 화초(火초) 등이 발명되었다. 그러나 이러한 것들은 세종에게서 아직 만족할 만한 수준에 도달한 것은 못되었다. 세종 26년에 화포주조소(火砲鑄造所)를 짓게 해 뛰어난 성능을 가진 새로운 규격의 화포를 만들어냈고, 이에 따라 이듬해는 화포의 전면 개주(改鑄)에 착수하였다. 세종 30년에 편찬 · 간행된 『총통등록(銃筒謄錄)』은 그 화포들의 주조법과 화약사용법, 그리고 규격을 그림으로 표시한 책이었다. 이 책의 간행은 조선시대의 화포제조에 새로운 전기를 마련한 주목할 만한 업적으로 평가된다."},
    {"Q": "세종대에는 어떤 농사법이 도입되었나요?", "A": "세종대에는 중국의 농서인 『농상집요(農桑輯要)』 · 『사시찬요(四時纂要)』 등과 우리 나라 농서인 『본국경험방(本國經驗方)』 등의 농업서적을 통해 농업기술의 계몽과 권장을 했으며, 정초가 지은 『농사직설(農事直說)』을 편찬 · 반포하였다. 이 책의 반포는 조선시대 농업과 농업기술사에 중요한 의의를 가진다. 의약발명에도 세종대는 특기할 만한 시대로서 『향약채집월령(鄕藥採集月令)』 · 『향약집성방(鄕藥集成方)』 · 『의방유취(醫方類聚)』주9 등의 의약서적이 편찬되었다. 『향약집성방(鄕藥集成方)』과 『의방유취(醫方類聚)』의 편찬은 15세기까지의 우리 나라와 중국 의약학의 발전을 결산한 것으로 조선과학사에서 빛나는 업적의 하나이다."},
    {"Q": "세종대의 음악에 대해 알고 싶어요.", "A": "세종대왕 시대는 음악에 있어서도 우리 역사상 가장 빛나는 업적을 남긴 시기였고, 그것은 세종의 지휘와 참여로서 이루어진 것이었다. 유교정치에 있어서 중요시되는 것이 유교적 의례인데, 국가의 의례인 오례에는 그에 합당한 음악이 따르게 마련이다. 따라서, 유교적인 의례의 정리와 함께 음악의 정리는 불가피한 것이었다. 세종의 음악적 업적은 크게 아악(雅樂)의 부흥, 악기(樂器)의 제작, 향악(鄕樂)의 창작, 정간보(井間譜)의 창안 등으로 나누어 볼 수 있다. 이와 같은 업적은 음악에 대한 깊은 관심과 조예를 가진 세종이 박연(朴堧)과 같은 음악의 전문가를 만남으로써 이루어질 수 있었다. 왕은 종래 미비하고 불완전한 아악을 바로잡기 위해 박연 등을 시켜 중국의 각종 고전을 참고해 아악기를 만들게 하고, 아악보를 새로 만들게 해, 조회아악(朝會雅樂) · 회례아악(會禮雅樂) 및 제례아악(祭禮雅樂) 등을 제정하였다. 그 뒤 아악은 국가 · 궁중의례에 연주되었고, 본고장인 중국보다도 완벽한 상태로 부흥시킬 수 있었다. 이와 같은 아악의 부흥은 그 악기의 국내 생산과 직결된 문제로서 종래 중국에서 수입했던 악기들을 국내에서 생산하였다. 특히, 가장 중요한 악기인 편경(編磬)과 편종(編鐘)도 대량으로 생산되었다. 세종은 또한 박연으로 하여금 율관(律管)을 제정하게 해 모든 악기의 음(音)을 조율(調律)하게 하였다. 뿐만 아니라 세종은 친히 ｢정대업(定大業)｣ · ｢보태평(保太平)｣ · ｢발상(發祥)｣ · ｢봉래의(鳳來儀)｣ 등 대곡(大曲)을 작곡하였다. 현재 국립국악원에서 연주되는 여민락(與民樂)도 ｢봉래의(鳳來儀)｣ 일곱 곡 중 한 곡이며, ｢정대업(定大業)｣과 ｢보태평(保太平)｣은 1964년 무형문화재로 지정되었다. 왕은 또한 기보법(記譜法)을 창안했으니, 곧 정간보(井間譜)가 그것이다. 정간보에 음의 시가(時價)와 박자를 표시할 수 있게 된 것이다. 세종은 이 정간보를 사용해 향악인 ｢정대업(定大業)｣ · ｢보태평(保太平)｣ · ｢봉래의(鳳來儀)｣ · ｢봉황음(鳳凰吟)｣ · ｢만전춘(滿殿春)｣ 등을 기보하였다. 정간보는 세조대에 약간 개량된 것을 현재에도 국악에 사용하고 있다."},
{"Q":"4군 6진이 무엇인가요?","A":"국토의 개척과 확장도 세종의 업적으로 빼놓을 수 없다. 두만강 방면에는 김종서(金宗瑞)를 보내서 6진을 개척하게 하였다. 그리고 압록강 방면에는 사군을 설치해 두만강과 압록강 이남을 영토로 편입하는 대업을 이루었다. 이와 같은 사업을 이룰 수 있었던 것은 세종이 문치(文治)만을 힘쓰지 않고 군사훈련, 화기의 제조 · 개발, 성진(城鎭)의 수축, 병선의 개량, 병서의 간행 등 국방책에도 힘을 기울인 결과인 것이다. 동쪽의 일본에 관해서는 강경책과 회유책을 함께 썼다. 세종 1년에는 이종무(李從茂) 등에게 왜구의 소굴인 대마도를 정벌하게 하는 강경책을 쓰기도 하였다. 그런 한편으로, 세종 8년에 삼포(三浦)를 개항하고, 세종 25년에는 계해약조를 맺어 이들을 회유하기도 하였다."},  
  {"Q": "세종대에는 어떤 치수 사업이 있었나요?", "A": "세종대에는 각종 하천과 저수지의 정비를 통해 치수 사업이 활발히 이루어졌습니다."},
    {"Q": "세종대의 기후 연구는 어떤 성과를 냈나요?", "A": "세종대에는 측우기 등을 이용한 기후 연구가 이루어져 농업과 일상생활에 필요한 기상 정보를 제공했습니다."},
    {"Q": "세종대의 불교 정책은 어땠나요?", "A": "세종대에는 유교를 중심으로 하는 정치 체제 속에서도 불교가 일정 부분 존중되었고, 불교 사찰과 관련된 정책이 시행되었습니다. 세종의 불교에 대한 태도는 말년에 오면서 크게 변하는데, 이는 세종 26년에 광평대군(廣平大君), 그 이듬해에 평원대군(平原大君), 세종 28년에 왕후를 연이어 잃게 됨에 따라 정신적으로 큰 타격을 입은 때문으로 보입니다. 또한, 세종대왕 자신의 건강도 악화된 것도 세종이 불교로 기우는 데 크게 영향을 주었습니다. 이 결과 세종 말년에 오면 세종과 유신간에 불교를 둘러싸고 격렬한 대립과 논란이 계속되었습니다. 이와 같은 현상이 발생한 것은 개국 초부터 국가의 기본시책이 숭유억불이었으나, 유교는 정치이념 · 학문 · 철학 · 윤리적인 면의 욕구를 채워줄 뿐, 종교적인 욕구가 충족될 수 없는 것이었기 때문입니다. 이러한 유불(儒佛)의 갈등 가운데에서도 세종대는 유교정치 · 유교사회의 기반이 다져진 시대였습니다."},
    {"Q": "세종대의 유교적 가치는 무엇이었나요?", "A": "세종대에는 유교적 가치가 정치와 사회의 기본 이념으로 자리 잡아 각종 제도와 법령에 반영되었습니다."},
    {"Q": "세종대의 법전 편찬은 어떻게 이루어졌나요?", "A": "세종대에는 『속육전』과 『신찬경제속육전』 등의 법전이 편찬되어 법제 정비와 통치의 기초가 마련되었습니다.한편으로는 형벌제도를 정비하고 흠휼정책(欽恤政策)도 시행하였습니다. 형정(刑政)에 관한 왕의 시책의 예를 들어보면 다음과 같습니다. 율문(律文)에 적합한 조목이 없는 경우에는 법률의 적용을 신중히 할 것, 고문으로 사망하는 일이 없도록 할 것, 사죄는 삼복법(三覆法)을 적용할 것 등과 고문에 태배법(笞背法)을 금하며, 의금부삼복법(義禁府三覆法)을 정하였습니다.15세 이하와 70세 이상인 자는 살인 · 강도죄를 제외하고는 수금(囚禁)하지 못하며, 10세 이하 80세 이상인 자는 사죄(死罪)를 범해도 수금하지 못하게 하였다. 그리고 도죄인(徒罪人)의 부모가 70세 이상인 자는 노친(老親)의 소재지에서 복역하도록 정하였다. 또한, 남형(濫刑)을 금할 것, 주인을 살해한 노비는 반드시 관에 고해 시행하게 할 것, 도류(徒流)주12 죄인의 수속금(收贖金)이 과중하므로 빈민에게는 감면하도록 할 것 등을 정했으며, 옥도(獄圖)를 중외(中外)에 반포하였다. 여러 차례 옥내(獄內)의 위생과 난방을 철저히 관리해 병들어 사망하는 일이 없도록 신칙하였다.세종 21년에는 양옥(凉獄) · 온옥(溫獄) · 남옥(男獄) · 여옥(女獄)에 관한 구체적인 조옥도(造獄圖)를 각 도에 반포했고, 세종 30년에는 옥수(獄囚)들의 더위와 추위를 막아주고 위생을 유지하기 위한 법을 유시(諭示)하기도 하였다. 세종은 형정에 신형(愼刑) · 흠휼정책을 썼으나 절도범에 관해서는 자자(刺字)주13 · 단근형(斷筋刑)주14을 정하였다. 그리고 절도3범은 교형(絞刑)에 처하는 등 사회기강을 확립하기 위한 형벌을 강화하기도 하였다. 또, 공법(貢法)을 제정함으로써 조선의 전세제도(田稅制度) 확립에도 업적을 남겼다. 종래의 세법이었던 답험손실법은 관리의 부정으로 인해 농민에게 주는 폐해가 막심했기 때문에 세종 12년에 이 법을 전폐하고 1결당 10두를 징수한다는 시안을 내놓고 문무백관에서 촌민에 이르는 약 17만 명의 여론을 조사했으나 결론을 얻지 못하였다. 세종 18년에 공법상정소(貢法詳定所)를 설치해 집현전 학자들도 이 연구에 참여하게 하는 등 연구와 시험을 거듭해 세종 26년에 공법을 확정하였다. 이 공법의 내용은 전분육등법(田分六等法) · 연분구등법(年分九等法) · 결부법(結負法)의 종합에 의한 것이며 조선시대 세법의 기본이 되었다.  "},
{"Q":"세종대왕의 역사적 의의를 알려주세요.","A":"세종대가 우리 민족의 역사상 빛나는 시대가 될 수 있었던 것은 정치적 안정 기반 위에 세종을 보필한 훌륭한 신하와 학자가 있었음을 간과할 수 없는 일이다. 그러나 이들의 보필을 받을 수 있었던 것은 세종의 사람됨이 그 바탕이었음을 잊어서는 안 될 것이다. 유교와 유교정치에 대한 소양, 넓고 깊은 학문적 성취, 역사와 문화에 대한 깊은 통찰력과 판단력, 중국문화에 경도(傾倒)되지 않은 주체성과 독창성, 의지를 관철하는 신념 · 고집, 노비에게까지 미칠 수 있었던 인정 등 세종 개인의 사람됨이 당시의 정치적 · 사회적 · 문화적 · 인적 모든 여건과 조화됨으로써 빛나는 민족문화를 건설할 수 있었다고 볼 수 있다."},
{"Q":"세종대왕에 대해 소개해주세요.","A":"세종대왕(1397년 ~ 1450년)은 조선시대 한국의 제4대 군주로, 조선의 중추적인 왕 중 하나로 인정받고 있다. 그의 통치는 한국 역사상 가장 영향력 있는 것 중 하나로 여겨지며, 세종 대왕은 문화, 과학, 정치, 교육 등 여러 분야에서 혁신적인 업적을 이루었다. 그의 통치는 한국의 역사와 문화에 큰 영향을 끼쳤다. 그의 업적은 현재도 한국 사회에서 크게 존경받고 있으며, 그의 이름은 한국의 국민들에게 특별한 의미를 지니고 있다."},
{"Q":"세종대왕의 교육 정책은 어땠나요?","A":"세종 대왕은 교육을 중요시하여 사대부의 특권을 제한하고 서민들의 교육을 촉진했다. 또한 신진 문인들을 후원하여 문화 예술의 발전에 기여했다."},
{"Q":"태종과의 관계를 알려주세요.","A":"세종대왕은 태종의 네 번째 아들로 태어났다. 태종은  세종에게 많은 영향을 끼쳤다. 세종은 아버지인 태종으로부터 정치적, 군사적 지식을 습득하고 아버지의 통치 철학을 배웠다."},
{"Q":"세종대왕의 관심사는 어땠나요?","A":"세종대왕은 다양한 분야에 관심을 가졌지만, 특히 문화와 과학 분야에 대한 관심이 매우 깊었다. 그의 통치 기간 동안 세종은 한글 창제와 같은 문화적 혁신을 이끌고, 천문학, 의학, 농업 등 다양한 과학적 연구를 촉진했다."},
{"Q":"세종대의 의학,의료 발전은 어땠나요?","A":"세종은 의학과 의료에도 큰 관심을 가졌다. 그는 조선의 의료 기술을 발전시키기 위해 의학 연구를 지원했으며, 국민들의 건강을 촉진하기 위해 의료 시스템을 개선했다."},
{"Q":"세종대의 농업 발전은 어땠나요?","A":"세종은 농업과 농촌 발전에도 큰 관심을 가졌다. 그는 농업 기술을 개선하고 농촌 지역의 발전을 촉진하기 위해 농업 연구를 지원했다. 그의 노력은 농촌 지역의 경제적인 번영과 국가의 식량 안정을 증진시켰다."},
{"Q":"세종대의 외교에 대해 알려주세요.","A":"세종대왕 시대의 외교관계는 다양한 요인에 따라 변화했지만, 대체로 안정적이고 활발한 외교 활동이 이루어졌다. 세종대왕은 조선 왕조의 외교 정책을 조율하여 인접 국가와의 관계를 유지하고, 국제적인 평화와 교류를 증진시키려는 노력을 기울였다.세종대왕은 명나라와의 관계,일본과의 관계,몽골과의 관계를 주로 신경썼다."},
{"Q":"세종대의 명나라와의 관계에 대해 알려주세요.","A":"세종대왕 시대에는 명나라와의 관계가 중요한 이슈였다. 명나라는 조선의 북방 국경에 인접해 있었고, 그 관계는 종종 긴장되기도 했다. 그러나 세종대왕은 명나라와의 외교적인 교류를 유지하려는 노력을 기울였고, 종종 협력과 상호 이해를 추구했다."},
{"Q":"세종대의 일본과의 관계에 대해 알려주세요.","A":"세종대왕 시대에는 조선과 일본 사이의 관계가 다양한 변화를 겪었다. 당시 일본은 조선과 교류를 원하면서도 종종 침략적인 행동을 보였고, 세종대왕은 일본과의 관계를 유지하면서도 국가의 안전과 안정을 보호하기 위해 노력했다."},
{"Q":"세종대의 몽골과의 관계에 대해 알려주세요.","A":"몽골은 세종대왕 시대에도 조선과 교류를 유지하는 중요한 이웃 국가였다. 몽골과의 관계는 종종 미국으로부터 영향을 받았으며, 세종대왕은 몽골과의 관계를 유지하면서도 국가의 안전과 이익을 보호하기 위해 노력했다."},
{"Q":"한글 창제대 대한 백성들의 반응은 어땠나요?","A":"한글 창제는 백성들의 문해율을 높이고 교육을 확대하는 데 큰 기여를 했다. 한글은 중세 조선의 문해 유산을 현대로 이어갔으며, 백성들이 문화 생활에 더욱 적극적으로 참여할 수 있게 했다."},
{"Q":"세종대왕의 연인,사랑에 대해 알려주세요.","A":"세종대왕은 여러 후궁을 둔 것으로 알려져 있지는 않다. 조선시대에는 왕이 여러 후궁을 둘 수 있었지만, 세종대왕은 단 한 명의 왕비(소양왕후 소양춘)와의 관계를 중요히 여겼다."},
{"Q":"세종대왕의 왕비는 누구였나요?","A":"세종대왕의 왕비는 소양왕후(昭陽王后)인 소왕춘(昭王春)입니다. 그녀는 세종대왕과의 사이에 총사 10명(세자 2명, 이원후 8명)을 낳았으며, 그 중에서 세종대왕의 후계자가 되는 세자 이황(太子 李芳)을 낳았다.세종대왕은 소양왕후와의 사이에 후궁을 두었던 것으로 알려져 있지 않다. 일반적으로 세종대왕은 가장 근위한 왕비인 소양왕후와의 관계를 중시하고, 그녀와의 사이에 다수의 자녀를 두었다. 따라서 세종대왕은 왕비인 소양왕후 이외 후궁은 기록되어 있지 않다."},
{"Q":"세종대왕의 말년에 대해 알려주세요.","A":"세종대왕은 역사에 길이 남을 위인이었지만,세종대왕의 말년은 그의 통치 생애 중 가장 어려운 시기 중 하나였다. 세종대왕은 노쇠와 질병으로 고통받던 가운데, 왕자 이환(後垣)의 반란과 왕비 소왕춘의 죽음 등 가족과 국정에서의 큰 변화에 직면했다. 세종대왕의 말년은 그의 통치 생애 중 가장 어려운 시기였지만, 그는 이런 어려움에도 불구하고 국가의 안전과 안정을 유지하기 위해 노력했다. 그의 결단력과 통솔력은 이른바 '세조(世祖)'라는 칭호를 받을 만큼 대대로 존경받게 되었으며, 세종대왕의 통치는 조선 역사상 빛나는 시대 중 하나로 기억되고 있다. "},
{"Q":"이환의 반란에 대해 알려주세요.","A":"세종대왕의 말년인 1450년에는 왕자 이환의 반란이 발생했다. 이환은 세종대왕의 왕위를 논란하고자 하며 군사력을 동원하여 반란을 일으켰다. 이 반란은 세종대왕의 권력에 대한 도전으로, 세종은 이를 진압하기 위해 군사력을 동원하여 신속하게 대응했다."}
]



# 데이터 전처리 및 형태소 분석을 위한 함수 정의. komlpy를 사용한다.
def preprocess_text(text):
    okt = Okt() #okt는 open korean text의 약자로, 한글 텍스트를 형태소 단위로 나누고 품사 태깅을 수행한다.
    tokens = okt.morphs(text)  # 형태소 분석 및 토큰화
    return ' '.join(tokens) #파이썬에서 문자열을 결합하기 위한 코드이다. 리스트의 문자열을 하나의 문자열로 결합하되, 각 요소 사이에 공백을 삽입하는 것이다.


# LSTM 모델 정의 및 학습
def train_lstm(data, max_seq_length, num_features):
    tokenizer = Tokenizer() #텍스트 데이터를 토큰화한다.
    tokenizer.fit_on_texts(data) #텍스트 데이터를 토크나이저에 맞춰 단어 인덱스를 구축한다.
    X = tokenizer.texts_to_sequences(data) #텍스트 데이터를 정수 시퀀스로 변환한다.
    X = pad_sequences(X, maxlen=max_seq_length)  # 시퀀스의 최대 길이로 패딩
### lstm 모델 정의
    model = Sequential() #순차적인 모델을 생성한다.
    model.add(LSTM(4096, input_shape=(max_seq_length, 1)))  # lstm 레이어를 추가한다. 가장 앞의 숫자는 lstm의 유닛 수를 의미하고, input_shape은 입력 데이터의 형태를 정의한다.
    #lstm 유닛 수가 늘어날 수록 정확도가 높아지는 결과를 얻을 수 있었다.
    model.add(Dense(max_seq_length))  # 출력 레이어 수정

    model.compile(loss='mean_squared_error', optimizer='adam', metrics=['accuracy']) #손실함수, 최적화 알고리즘, 평가 지표를 정의한다. 
    history =model.fit(X[:, :, None], X, epochs=200, batch_size=128)  # 데이터를 3D 텐서로 변환하여 입력한다. 이는 데이터를 맞추지 않으면 오류가 나기 때문이다. 

   
    #epochs는 모델 학습의 수이다. batch_size는 배치 크기를 64로 설정하는 것이다. 
    #모델을 저장함으로서, 모델 학습을 매번 시키지 않아도 모델을 쓸 수 있게 한다.  h5는 구식이므로 keras을 통해 저장해야 한다.
    model.save('chatbot_model.keras')
    return model, tokenizer #학습된 모델과 토크나이저를 반환한다.


#코사인 유사도를 이용해서 질문과 유사한 데이터를 q배열에서 찾는 함수이다.
def find_similar_answer(question, data, vectorizer, model, tokenizer,threshold=1.0): #여기서 threshold는 한계점이라는 뜻이며, 정확도가 일정 수준 이하이면 질문을 이해할 수 없다는 답변을 출력한다.
    okt = Okt() #konlpy의 okt 사용
    question = preprocess_text(question) #질문을  okt를 사용해서 전처리한다. 
    question_vec = vectorizer.transform([question]) #질문을 TF-IDF 벡터화한다. 이를 통해 유사도를 계산할 준비를 한다. 
    question_seq = tokenizer.texts_to_sequences([question])# 질문을 시퀀스로 변환한다.
    question_seq = pad_sequences(question_seq, maxlen=model.input_shape[1])# 패딩 처리.

    max_sim = -1 
    most_similar_answer = None #가장 유사한 답변을 담을 변수를 초기화한다. 

    for i, qa in enumerate(data): #qa 배열을 data에 받는다. data는 q도 있고, a도 있기 때문에, enumerate을 통해 받는다. 
        q = qa['Q'] #qa배열에서 현재의 질문을 추출한다. 
        q_vec = vectorizer.transform([preprocess_text(q)])  # 질문을 전처리한 뒤, TF-IDF 벡터화한다.
        sim = cosine_similarity(question_vec, q_vec)[0][0] #입력 질문과 데이터 질문 사이의 코사인 유사도를 계산한다. 

        q_seq = tokenizer.texts_to_sequences([preprocess_text(q)])  # 질문 전처리한뒤, 시퀀스를 패딩한다.(데이터에 특정 값을 채워서 데이터의 크기를 조정하는 것)
        q_seq = pad_sequences(q_seq, maxlen=question_seq.shape[1]) #시퀀스를 패딩한다. shape[1]은 시퀀스의 길이를 나타낸다.

        lstm_sim = model.predict([question_seq, q_seq])  # LSTM을 통해 입력 질문 시퀀스와 데이터 질문 시퀀스 간의 유사도를 예측한다.
        avg_sim = (sim + lstm_sim.mean()) / 2  # lstm_sim의 평균 값을 사용
        print(avg_sim)#입력 질문 시퀀스와 데이터 질문 시퀀스 간의 유사도를 예측한 값을 프린트한다.

        # numpy 배열로 비교
        if np.any(avg_sim > max_sim): #np.any는 조건을 만족하는지 확인한다.
            max_sim = avg_sim #지금 유사도가 기존의 max_sim보다 크면 값을 새로 업데이트 한다.
            most_similar_answer = qa['A'] if max_sim >= threshold else "그 질문은 이해할 수 없다네. 가엽고 딱한 자로다!" #이에 따라 가장 유사한 답변을 업데이트 한다.

    return most_similar_answer


#lstm 모델을 학습한다.

# 데이터 로드 및 전처리
questions = [qa['Q'] for qa in organized_data]  # 질문만 추출한다.

# 질문들을 okt를 사용해서 전처리하여 TF-IDF 벡터화한다.
processed_questions = [preprocess_text(q) for q in questions]
vectorizer = TfidfVectorizer() #TfidfVectorizer 정의
X = vectorizer.fit_transform(processed_questions)
num_features = X.shape[1]  # TF-IDF 벡터화된 데이터의 피처 수. qa배열의 실제 데이터에 따라 모델의 변수를 정의한다. 

# 최대 시퀀스 길이 계산
max_seq_length = max([len(q.split()) for q in processed_questions])

# LSTM 모델 학습
lstm_model, tokenizer = train_lstm(processed_questions, max_seq_length, num_features)


#matplotlib을 통해 정확도를 시각화하는 부분을 skip하도록 한다.

#세종대왕과 직접 대와하는 챗봇'을 만드는 것이 목표이기에, 어휘를 변환해서 실제로 세종대왕과 직접 대화하는 것 같이 만들자.

# 어휘 목록
word_map = {
    "세종대왕": "과인",
    "세종대": "과인의 시기",
    "세종이": "과인이",
    "세종은": "과인은",
    "세종의": "과인의",
    "이 시기": "과인의 시대에",
    "세종에게서": "과인에게서",
    "세종대왕 시대": "과인의 시대",
    "세종도": "과인도",
    "니다": "다네",
    "그의": "과인의",
    "세종에게":"과인에게"
}

# 어휘 변환 함수
def replace_words(text, word_map):
    for key, value in word_map.items():
        text = text.replace(key, value)
    return text



def add_dane_suffix(text):
    # 문장 끝의 종결어미를 찾아 '다네'로 변경
    sentences = re.split(r'([.?!])', text)  # 문장을 구분하는 정규 표현식
    new_sentences = []
    
    for i in range(0, len(sentences) - 1, 2):
        sentence = sentences[i].strip()
        punctuation = sentences[i + 1]
        if sentence:  # 문장이 비어있지 않다면
            if sentence.endswith(('다', '까', '니', '라', '냐', '는가', '나요')):
                sentence = sentence[:-1]  # 마지막 글자를 제거
            new_sentences.append(sentence + '다네' + punctuation)
    
    # 마지막 문장이 구두점으로 끝나지 않은 경우
    if len(sentences) % 2 != 0:
        sentence = sentences[-1].strip()
        if sentence:
            if sentence.endswith(('다', '까', '니', '라', '냐', '는가', '나요')):
                sentence = sentence[:-1]  # 마지막 글자를 제거
            new_sentences.append(sentence + '다네')
    
    return ' '.join(new_sentences)



#챗봇 로직

def generate_response(question):
    while True: #무한 루프. '종료'를 누르기 전까지 질문과 답변이 계속된다.
       
        
        # 유사한 답변을 찾는다.
        answer = find_similar_answer(question, organized_data, vectorizer, lstm_model, tokenizer)
        
        # 답변을 변환한다.
        transformed_answer = replace_words(answer, word_map)
        final_answer = add_dane_suffix(transformed_answer)
        
        # 최종 답변을 return한다.
        return final_answer
        


